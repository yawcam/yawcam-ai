name: Build & Push Docker Images
on:
  workflow_dispatch: # allow the action to be run manually on selected branches
  push: # Add this temporarily
    branches:
      - 'docker' # Trigger on pushes to the 'docker' branch

# Define environment variables for easy reuse
env:
  DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}
  PLATFORM: linux/amd64,linux/arm64
  BUILD_YAWCAM_AI: 'true'
  BUILD_YAWCAM_AI_CUDA: 'true'
  BUILD_YAWCAM_AI_FULL: 'true'

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üìÑ Get version
        id: get-version
        run: |
          VERSION=$(cat ./docker/version.txt)
          echo $VERSION
          if [[ $VERSION =~ "beta" ]] || [[ $VERSION =~ "alpha" ]]; then
            echo "Version contains 'beta' or 'alpha' -> Pre-release"
            PRE_RELEASE=true
          else
            PRE_RELEASE=false
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "PRE_RELEASE=$PRE_RELEASE" >> $GITHUB_ENV

      # --- Docker Hub Authentication ---
      - name: üîë Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # --- Setup QEMU for Multi-Arch Builds ---
      # This is a best practice to allow building for arm64 (e.g., Raspberry Pi)
      - name: ‚öôÔ∏è Set up QEMU
        uses: docker/setup-qemu-action@v3

      # --- Setup Buildx (The modern Docker builder) ---
      - name: ‚öôÔ∏è Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- Generate Metadata & Tags ---
      - name: üê≥ Docker Meta, yawcam-ai
        if: ${{ env.BUILD_YAWCAM_AI == 'true' }}
        id: meta-yawcam-ai
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_USERNAME }}/yawcam-ai
          tags: |
            # Only tag 'latest' if PRE_RELEASE is false
            type=raw,value=latest,enable=${{ env.PRE_RELEASE == 'false' }}
            # Always set 'edge' tag to the most recent build
            type=raw,value=edge
            # Always set version tag
            type=raw,value=${{ env.VERSION }}

      # --- Build and Push the Image ---
      - name: üèóÔ∏è Build and Push, yawcam-ai
        if: ${{ env.BUILD_YAWCAM_AI == 'true' }}
        uses: docker/build-push-action@v6
        with:
          context: ./docker/yawcam-ai
          file: ./docker/yawcam-ai/Dockerfile
          platforms: ${{ env.PLATFORM }}
          push: true
          build-args: |
            YAWCAM_VERSION=${{ env.VERSION }}
          # Use the tags generated by the meta step
          tags: ${{ steps.meta-yawcam-ai.outputs.tags }}

      # --- Generate Metadata & Tags ---
      - name: üê≥ Docker Meta, yawcam-ai-cuda
        if: ${{ env.BUILD_YAWCAM_AI_CUDA == 'true' }}
        id: meta-yawcam-ai-cuda
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_USERNAME }}/yawcam-ai-cuda
          tags: |
            # Only tag 'latest' if PRE_RELEASE is false
            type=raw,value=latest,enable=${{ env.PRE_RELEASE == 'false' }}
            # Always set 'edge' tag to the most recent build
            type=raw,value=edge
            # Always set version tag
            type=raw,value=${{ env.VERSION }}

      # --- Build and Push the Image ---
      - name: üèóÔ∏è Build and Push, yawcam-ai-cuda
        if: ${{ env.BUILD_YAWCAM_AI_CUDA == 'true' }}
        uses: docker/build-push-action@v6
        with:
          context: ./docker/yawcam-ai-cuda
          file: ./docker/yawcam-ai-cuda/Dockerfile
          platforms: ${{ env.PLATFORM }}
          push: true
          build-args: |
            YAWCAM_VERSION=${{ env.VERSION }}
          # Use the tags generated by the meta step
          tags: ${{ steps.meta-yawcam-ai-cuda.outputs.tags }}

      # --- Generate Metadata & Tags ---
      - name: üê≥ Docker Meta, yawcam-ai-full
        if: ${{ env.BUILD_YAWCAM_AI_FULL == 'true' }}
        id: meta-yawcam-ai-full
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_USERNAME }}/yawcam-ai-full
          tags: |
            # Only tag 'latest' if PRE_RELEASE is false
            type=raw,value=latest,enable=${{ env.PRE_RELEASE == 'false' }}
            # Always set 'edge' tag to the most recent build
            type=raw,value=edge
            # Always set version tag
            type=raw,value=${{ env.VERSION }}

      # --- Build and Push the Image ---
      - name: üèóÔ∏è Build and Push, yawcam-ai-full
        if: ${{ env.BUILD_YAWCAM_AI_FULL == 'true' }}
        uses: docker/build-push-action@v6
        with:
          context: ./docker/yawcam-ai-full
          file: ./docker/yawcam-ai-full/Dockerfile
          platforms: ${{ env.PLATFORM }}
          push: true
          build-args: |
            YAWCAM_VERSION=${{ env.VERSION }}
          # Use the tags generated by the meta step
          tags: ${{ steps.meta-yawcam-ai-full.outputs.tags }}